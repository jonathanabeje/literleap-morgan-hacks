{% extends "layout.html" %}

{% block content %}
<div class="content-area">
    <h1 class="mb-4">Writing Practice</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex align-items-center flex-wrap">
                <select id="exercise-type-selector" class="form-select me-3 mb-2" style="width: auto;">
                    <option value="word" selected>Spelling (Word)</option>
                    <option value="phrase">Dictation (Phrase)</option>
                </select>
                
                <select id="difficulty-selector" class="form-select me-3 mb-2" style="width: auto;">
                    <option value="beginner">Beginner</option>
                    <option value="elementary">Elementary</option>
                    <option value="intermediate" selected>Intermediate</option>
                    <option value="advanced">Advanced</option>
                    <option value="expert">Expert</option>
                </select>
                
                <select id="category-selector" class="form-select me-3 mb-2" style="width: auto;">
                    <option value="" selected>Random Category</option>
                    <!-- Categories will be populated by JS -->
                </select>
                
                <button id="new-exercise-btn" class="btn btn-outline-primary mb-2">
                    <i class="fas fa-sync-alt me-2"></i> New Exercise
                </button>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h2 id="exercise-title" class="mb-4">Spelling Exercise</h2>
            
            <div class="alert alert-primary">
                <i class="fas fa-info-circle me-2"></i>
                <strong id="exercise-instruction">{{ exercise.instruction }}</strong>
            </div>
            
            <div class="row mt-4">
                <div class="col-lg-6">
                    <div class="card bg-light p-4 mb-4">
                        <h4 class="mb-3">
                            <i class="fas fa-volume-up me-2"></i> <span id="listen-label">Listen to the word</span>
                        </h4>
                        
                        <div class="d-flex align-items-center">
                            <button id="listen-btn" class="btn btn-primary">
                                <i class="fas fa-play me-2"></i> Play Audio
                            </button>
                            
                            <div class="ms-3 text-muted" id="word-hint">
                                <em>Hint: {{ exercise.hint }}</em>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mb-4" id="word-input-container">
                        <label for="spelling-input" class="form-label">Your answer:</label>
                        <input type="text" id="spelling-input" class="form-control form-control-lg" 
                               placeholder="Type the word here...">
                    </div>
                    
                    <div class="form-group mb-4 d-none" id="phrase-input-container">
                        <label for="phrase-input" class="form-label">Your answer:</label>
                        <textarea id="phrase-input" class="form-control" rows="3"
                                  placeholder="Type the complete phrase here..."></textarea>
                    </div>
                    
                    <button id="submit-answer-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-check me-2"></i> Submit Answer
                    </button>
                </div>
                
                <div class="col-lg-6" id="feedback-container" style="display: none;">
                    <div id="correct-feedback" class="alert alert-success d-none">
                        <h4><i class="fas fa-check-circle me-2"></i> Correct!</h4>
                        <p>Great job! You spelled it correctly.</p>
                    </div>
                    
                    <div id="incorrect-feedback" class="alert alert-danger d-none">
                        <h4><i class="fas fa-times-circle me-2"></i> Not quite right</h4>
                        <p>The correct text is: <strong id="correct-text"></strong></p>
                    </div>
                    
                    <div class="card p-4 mt-4">
                        <h4 class="mb-3">Character Analysis</h4>
                        <div id="character-feedback" class="character-feedback mb-3">
                            <!-- Character feedback will be inserted here -->
                        </div>
                        
                        <div id="spelling-rule" class="alert alert-info mt-3 d-none">
                            <i class="fas fa-lightbulb me-2"></i>
                            <span id="spelling-rule-text"></span>
                        </div>
                    </div>
                    
                    <button id="next-exercise-btn" class="btn btn-primary mt-4">
                        <i class="fas fa-arrow-right me-2"></i> Next Exercise
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Challenge words section (only visible for word exercises) -->
    <div class="card mb-4" id="challenge-section">
        <div class="card-body">
            <h3 class="mb-3">Spelling Challenges</h3>
            <p>Practice with these common spelling challenges:</p>
            
            <div class="row">
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-secondary w-100" data-challenge="silent_letters">
                        Silent Letters
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-secondary w-100" data-challenge="double_consonants">
                        Double Consonants
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-secondary w-100" data-challenge="ie_ei_words">
                        I before E
                    </button>
                </div>
                <div class="col-md-3 mb-2">
                    <button class="btn btn-outline-secondary w-100" data-challenge="homophones">
                        Homophones
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/data/word_database.js"></script>
<script>
    let currentExercise = {{ exercise|tojson }};
    let isAnswerSubmitted = false;
    let currentDifficulty = "intermediate";
    let currentCategory = "";
    let currentExerciseType = "word";
    
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('listen-btn').addEventListener('click', playAudio);
        document.getElementById('submit-answer-btn').addEventListener('click', checkAnswer);
        document.getElementById('next-exercise-btn').addEventListener('click', getNewExercise);
        document.getElementById('new-exercise-btn').addEventListener('click', getNewExercise);
        
        // Allow pressing Enter to submit
        document.getElementById('spelling-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        document.getElementById('phrase-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                checkAnswer();
            }
        });
        
        // Set up difficulty selector
        document.getElementById('difficulty-selector').addEventListener('change', function() {
            currentDifficulty = this.value;
            if (currentExerciseType === 'word') {
                updateCategorySelector(currentDifficulty);
            }
        });
        
        // Set up exercise type selector
        document.getElementById('exercise-type-selector').addEventListener('change', function() {
            currentExerciseType = this.value;
            updateExerciseTypeUI(currentExerciseType);
        });
        
        // Set up category selector
        document.getElementById('category-selector').addEventListener('change', function() {
            currentCategory = this.value;
        });
        
        // Set up challenge buttons
        document.querySelectorAll('[data-challenge]').forEach(button => {
            button.addEventListener('click', function() {
                const challengeType = this.getAttribute('data-challenge');
                loadChallengeExercise(challengeType);
            });
        });
        
        // Initialize category selector
        updateCategorySelector(currentDifficulty);
    });
    
    function updateExerciseTypeUI(type) {
        const categorySelector = document.getElementById('category-selector');
        const challengeSection = document.getElementById('challenge-section');
        const exerciseTitle = document.getElementById('exercise-title');
        const listenLabel = document.getElementById('listen-label');
        const wordInputContainer = document.getElementById('word-input-container');
        const phraseInputContainer = document.getElementById('phrase-input-container');
        
        if (type === 'word') {
            exerciseTitle.textContent = 'Spelling Exercise';
            listenLabel.textContent = 'Listen to the word';
            categorySelector.disabled = false;
            challengeSection.classList.remove('d-none');
            wordInputContainer.classList.remove('d-none');
            phraseInputContainer.classList.add('d-none');
            updateCategorySelector(currentDifficulty);
        } else {
            exerciseTitle.textContent = 'Dictation Exercise';
            listenLabel.textContent = 'Listen to the phrase';
            categorySelector.disabled = true;
            challengeSection.classList.add('d-none');
            wordInputContainer.classList.add('d-none');
            phraseInputContainer.classList.remove('d-none');
        }
        
        // Get a new exercise based on the selected type
        getNewExercise();
    }
    
    function updateCategorySelector(difficulty) {
        const categorySelector = document.getElementById('category-selector');
        
        if (currentExerciseType !== 'word') {
            while (categorySelector.options.length > 1) {
                categorySelector.remove(1);
            }
            return;
        }
        
        const categories = getCategoriesForLevel(difficulty);
        
        // Clear current options except the first one
        while (categorySelector.options.length > 1) {
            categorySelector.remove(1);
        }
        
        // Add new options
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            categorySelector.appendChild(option);
        });
    }
    
    function playAudio() {
        if ('speechSynthesis' in window) {
            const textToSpeak = currentExerciseType === 'word' 
                ? currentExercise.target_word 
                : currentExercise.target_text;
                
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.rate = 0.8; // Slow down a bit for clarity
            window.speechSynthesis.speak(utterance);
        } else {
            // Fallback if speech synthesis is not available
            alert(`The ${currentExerciseType} is: ${currentExerciseType === 'word' ? currentExercise.target_word : currentExercise.target_text}`);
        }
    }
    
    function checkAnswer() {
        if (isAnswerSubmitted) {
            return;
        }
        
        // Get the user's answer based on exercise type
        const userAnswer = currentExerciseType === 'word' 
            ? document.getElementById('spelling-input').value.trim() 
            : document.getElementById('phrase-input').value.trim();
            
        const targetText = currentExerciseType === 'word' 
            ? currentExercise.target_word 
            : currentExercise.target_text;
        
        if (!userAnswer) {
            alert('Please enter your answer first');
            return;
        }
        
        // Show feedback container
        document.getElementById('feedback-container').style.display = 'block';
        
        // Check if answer is correct (case insensitive)
        const isCorrect = userAnswer.toLowerCase() === targetText.toLowerCase();
        
        if (isCorrect) {
            document.getElementById('correct-feedback').classList.remove('d-none');
            document.getElementById('incorrect-feedback').classList.add('d-none');
        } else {
            document.getElementById('correct-feedback').classList.add('d-none');
            document.getElementById('incorrect-feedback').classList.remove('d-none');
            document.getElementById('correct-text').innerText = targetText;
            
            // Show spelling rule hint based on word type
            document.getElementById('spelling-rule').classList.remove('d-none');
            if (currentExercise.note) {
                document.getElementById('spelling-rule-text').innerText = currentExercise.note;
            } else {
                document.getElementById('spelling-rule-text').innerText = 
                    currentExerciseType === 'word' 
                        ? "Try sounding out the word by syllables, and remember to check your spelling carefully." 
                        : "Try listening to the phrase again and pay attention to every word.";
            }
        }
        
        // Send to server for detailed analysis
        fetch('/check_spelling', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                answer: userAnswer,
                target_text: targetText,
                exercise_type: currentExerciseType
            })
        })
        .then(response => response.json())
        .then(data => {
            // Update character feedback
            const characterFeedback = document.getElementById('character-feedback');
            characterFeedback.innerHTML = '';
            
            data.comparison.forEach(item => {
                let charSpan = '';
                
                if (item.status === 'correct') {
                    charSpan = `<span class="char-correct">${item.char}</span>`;
                } else if (item.status === 'incorrect') {
                    charSpan = `<span class="char-incorrect">${item.char}</span>`;
                } else if (item.status === 'missing') {
                    charSpan = `<span class="char-missing">${item.char}</span>`;
                } else if (item.status === 'extra') {
                    charSpan = `<span class="char-extra">${item.user_char}</span>`;
                }
                
                characterFeedback.innerHTML += charSpan;
            });
            
            // Update spelling rule if provided from server
            if (data.feedback && !isCorrect) {
                document.getElementById('spelling-rule-text').innerText = data.feedback;
            }
        })
        .catch(error => {
            console.error('Error checking answer:', error);
        });
        
        isAnswerSubmitted = true;
    }
    
    function getNewExercise() {
        isAnswerSubmitted = false;
        document.getElementById('feedback-container').style.display = 'none';
        document.getElementById('spelling-input').value = '';
        document.getElementById('phrase-input').value = '';
        
        if (currentExerciseType === 'word') {
            // Get a new word exercise
            const wordInfo = getRandomWord(currentDifficulty, currentCategory || null);
            
            // Update the current exercise
            currentExercise = {
                instruction: "Listen to the word and type it correctly.",
                target_word: wordInfo.word,
                hint: wordInfo.hint,
                note: wordInfo.note || null
            };
            
            // Update the UI
            document.getElementById('exercise-instruction').textContent = currentExercise.instruction;
            document.getElementById('word-hint').innerHTML = `<em>Hint: ${currentExercise.hint}</em>`;
        } else {
            // Get a new phrase exercise
            const phraseInfo = getRandomPhrase(currentDifficulty);
            
            // Update the current exercise
            currentExercise = {
                instruction: "Listen to the phrase and type it exactly as you hear it.",
                target_text: phraseInfo.text,
                hint: phraseInfo.hint
            };
            
            // Update the UI
            document.getElementById('exercise-instruction').textContent = currentExercise.instruction;
            document.getElementById('word-hint').innerHTML = `<em>Hint: ${currentExercise.hint}</em>`;
        }
    }
    
    function loadChallengeExercise(challengeType) {
        if (currentExerciseType !== 'word') {
            return;
        }
        
        isAnswerSubmitted = false;
        document.getElementById('feedback-container').style.display = 'none';
        document.getElementById('spelling-input').value = '';
        
        // Get a challenge word
        const wordInfo = getChallengeWord(challengeType);
        
        // Update the current exercise
        currentExercise = {
            instruction: "Listen to the word and type it correctly.",
            target_word: wordInfo.word,
            hint: wordInfo.hint,
            note: wordInfo.note || null
        };
        
        // Update the UI
        document.getElementById('exercise-instruction').textContent = currentExercise.instruction;
        document.getElementById('word-hint').innerHTML = `<em>Hint: ${currentExercise.hint}</em>`;
    }
</script>
{% endblock %} 